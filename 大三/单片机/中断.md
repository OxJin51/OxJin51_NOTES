# 中断

注：如何避免每次都重写`delay()`延时函数？

**答案**: 将`delay`函数封装成一个公共模块，体现模块化的编程思想。

1.  **创建公共资源文件夹**:
    * `delay.c`
    * `delay.h`
2.  **文件 delay.c 的标准写法**:

```c
/*

 * 自定义双参数延时函数
 * 通过改变参数x和y的值来控制延时长度
   */
   void delay(unsigned int x, unsigned int y) 
   {
   unsigned int i, j;
   for (i = 0; i < x; i++)
   {
       for (j = 0; j < y; j++);
   }
   }
```

3. **头文件 `delay.h` 的标准写法**:

使用条件编译指令 `#ifndef...#define...#endif` 来防止头文件被重复包含。

```c
#ifndef __delay_h__
#define __delay_h__

void delay (unsigned int z,unsigned int w)
{
    unsigned int i,j;
    for(i=0;i<z;i++)
        for(j=0;j<w;j++);
}

#endif
```

**计时规则**：以delay(1000,40)=0.5 s 为基准来控制时间：

- `delay(1000, 40*2);`≈ 1 秒
- `delay(1000, 40);`≈ 0.5 秒
- `delay(1000, 40/2);`≈ 0.25 秒
- `delay(1000, 40/4);`≈ 0.125 秒



中断源

总共5个

INT0 外部中断0

INT1 外部中断1

T0 定时器





### 课堂应用：8个数码管上依次显示0~7的数字走马，使用外部中断0（INT0）作为唯中断源，由独立按键K1按下产生中断申请，当中断发生时，数字走马停止走马，蜂鸣器发出1k Hz频率的连续声音；当中断撤销是，数字走马恢复走动，蜂鸣器不发声。



硬件连接：数码管P0口，P2口第三位接译码器，P1.0接蜂鸣器，P3.2接独立按键K1。

```c
#include<reg52.h>
#include"delay.h"
#define uint unsigned int

Sbit fmq=P1^0;

Sbit K1=P3^2;

uint i;
uint code weixuan[] = {0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07}; // 位选数组
uint code duanma[] ={0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,0x07,0x7f,0x6f,0x77,0x7c,0x39,0x5e,0x79,0x71}; //段码数组
void main()
{

	IT0=0; // 低电平触发

	EX0=1; // 源允许

	EA=1; //总开关



    while(1)  // 走马数组

   {

	for(i=0;i<8;i++)

	{

		P2=weixuan[i];

		P0=duanma[i];

		delay(1000,40);

		P0=0x00;

	}      

   }
}

void ex0_int() interrupt 0

{

	// 防止被自己中断

	EX0=0;

	fmq=~fmq;

	delay(1000/1000,40)

    EX0=1;

}
```





提问：如果把外部中断0改成外部中断1，硬件和软件应该怎么修改？

### 课堂应用3：主程序：蜂鸣器发出连续声音。外部中断0：大数码管显示0，停止发出声音。外部中断1：大数码管显示1，停止发出声音。

#include<reg52.h>

#include"delay.h"

sbit fmq=P1^0;

void main()

{

​	IT0=0;

​	IT1=0;

​	EX0=1;

​	EX1=1;

​	EA=1;

​	while(1)

​	{

​		fmq=~fmq;

​		delay(1000/500,42/3)；

​	}

}



void ex0_int() interrupt 0

{

​	EX0=0;

​	fmq=0; //固定高电平或者低电平

​	P0=~0x3f; //注意大数码管是共阳极的，要取反

​	EX0=1;

}

void ex1_int() interrupt 2

{

​	EX1=0;

​	fmq=0; //固定高电平或者低电平

​	P0=~0x06; //注意大数码管是共阳极的，要取反

​	// 解决问题

​	while(!K8); P0=~0x00;

​	EX1=1;

}



提问：中断结束后，数字还显示，如何解决？

答：检测按键松手

### 课堂应用4：主程序：蜂鸣器发出连续声音。外部中断0：大数码管显示0，停止发出声音。外部中断1：大数码管显示1，停止发出声音。

主程序：左移走马灯。外部中断0：高4位，低4位交替闪烁。外部中断1：显示4；