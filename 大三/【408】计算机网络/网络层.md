### 4-01 网络层向上提供的服务有哪两种？试比较其优缺点。

#### 1. 知识点讲解

根据PPT内容，网络层在向其上层（即运输层）提供服务时，有两种不同的观点：

1. **面向连接的虚电路服务 (Virtual Circuit Service)** 这种观点认为，网络层应该模仿电信网络，提供一种可靠的、面向连接的通信方式。 在通信前，双方必须先建立一条逻辑上的连接，称为虚电路 (VC)。 一旦建立连接，所有的数据分组都会沿着这条预先建立的虚电路按序传输。 网络层负责保证通信的可靠性，确保分组无差错、按顺序、不丢失、不重复地到达终点。
2. **无连接的数据报服务 (Datagram Service)** 这种观点是互联网(Internet)所采用的设计思路。 网络层被设计得尽量简单，它向上层只提供一种“简单灵活的、无连接的、尽最大努力交付的”数据报服务。 **无连接 (Connectionless)**：发送分组前不需要先建立连接。 **尽最大努力交付 (Best-Effort)**：网络层不提供任何服务质量的承诺。分组在传输中可能出错、丢失、重复或失序（不按序到达）。 **独立路由**：每个分组（IP数据报）都独立发送，前后分组可能沿着不同的路径传送。 在这种模式下，可靠的通信由上层（即运输层，如TCP）来负责。

#### 2. 题目解答（优缺点比较）

这两种服务的优缺点可以总结如下：

| 对比方面       | 虚电路服务 (优点/缺点)                                       | 数据报服务 (优点/缺点)                                       |
| -------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **设计思路**   | 网络负责可靠通信。                                           | 用户主机（运输层）负责可靠通信。                             |
| **连接建立**   | 必须建立连接。（缺点：有建立连接的时延。）                   | 不需建立连接。（优点：灵活、迅速。）                         |
| **分组寻址**   | 仅在连接建立时使用完整地址，后续分组使用短的虚电路号。（优点：首部开销较小。） | 每个分组都必须携带完整的终点地址。（缺点：首部开销较大。）   |
| **转发路径**   | 所有分组按同一路由（虚电路）转发。                           | 每个分组独立选择路由转发。                                   |
| **可靠性**     | 按序到达。网络可负责差错和流量控制。（优点：为上层提供可靠服务。） | 不一定按序到达。差错和流量控制由主机负责。（缺点：网络层本身不可靠。） |
| **故障适应性** | 当某个结点出故障时，所有通过该结点的虚电路均不能工作。（缺点：网络鲁棒性较差。） | 结点出故障时，分组可能丢失，但路由可发生变化，后续分组可绕过故障结点。（优点：网络鲁棒性（健壮性）好。） |

------

### 4-15 一个3200位长的TCP报文传到IP层，加上160位的首部后成为数据报。...第二个局域网所能传输的最长数据帧中的数据部分只有1200位，因此数据报在路由器中必须进行分片。试问第二个局域网向其上层要传送多少比特的数据（这里的“数据”当然指的是局域网看得见的数据）？

#### 1. 知识点讲解

1. **IP数据报结构**：一个IP数据报由“首部”和“数据”两部分组成。PPT中指出，固定的首部长度为20字节，即 20×8=160位。
2. **MTU与分片**：当IP数据报的总长度超过了数据链路层的最大传送单元 (MTU) 时，就必须进行分片。分片时，原始数据报的数据部分被分割，而每个分片都拥有自己的IP首部。
3. **分片偏移 (Fragment Offset)**：在IP首部中，“片偏移”字段指明了某片数据在原分组中的相对位置。关键是，**片偏移是以8个字节（即64位）为单位的**。这意味着，除了最后一个分片外，每个分片的数据部分长度必须是8字节（64位）的整数倍。

#### 2. 题目解答

1. **计算原始IP数据报** TCP报文（IP数据报的数据部分）= 3200 位 IP首部 = 160 位 原始IP数据报总长度 = 3200+160=3360位

2. **分析分片限制** 第二个局域网的MTU（其数据帧能承载的数据部分，即IP数据报的最大长度）= 1200 位。 每个分片都需要一个IP首部 = 160 位。 因此，每个分片所能承载的*最大数据*长度 = MTU - 首部长度 = 1200−160=1040位。

3. **遵从8字节（64位）对齐** 根据“片偏移”规则，每个分片的数据部分必须是8字节（64位）的倍数。 最大数据长度是1040位。检查其是否为64的倍数：1040÷64=16.25。 它不是64的倍数。必须取*小于*1040的、64的最大整数倍。 ⌊16.25⌋=16。 因此，每个分片（除最后一个）的数据部分实际最大长度为：16×64=1024位。

4. **进行分片** 原始数据报总数据 = 3200 位。 **分片 1**： 数据：1024 位 首部：160 位 总长度：1024+160=1184位 (小于1200位MTU) **分片 2**： 剩余数据：3200−1024=2176位 数据：1024 位 首部：160 位 总长度：1024+160=1184位 **分片 3**： 剩余数据：2176−1024=1152位 数据：1024 位 首部：160 位 总长度：1024+160=1184位 **分片 4 (最后一片)**： 剩余数据：1152−1024=128位 数据：128 位 (最后一片不需要是64的倍数) 首部：160 位 总长度：128+160=288位

5. **计算总传送数据** 题目问的是“第二个局域网向其上层要传送多少比特的数据”，并且括号中注明“（这里的“数据”当然指的是局域网看得见的数据）”。 “局域网看得见的数据”就是它在数据链路层所承载的*全部*IP分片（包括首部和数据）。 总传送比特数 = 分片1总长度 + 分片2总长度 + 分片3总长度 + 分片4总长度 总传送比特数 = 1184+1184+1184+288=3840位。

    *(注：这3840位数据被第二个局域网传输后，在目的地的IP层被重组，IP层再向其上层（运输层）传送原始的3200位TCP报文。)*

------

### 4-20 一个数据报长度为4000字节（固定首部长度）。现在经过一个网络传送，但此网络能够传输的最大数据长度为1500字节。试问应当划分为几个短些的数据报片？各数据报片的数据字段长度、片偏移字段和MF标志应为何数值？

#### 1. 知识点讲解

此题同样考察IP数据报的分片。涉及的关键知识点如下：

1. **IP首部**：固定首部长度为20字节。
2. **MTU**：网络能传输的最大数据长度（MTU）限制了每个IP分片的最大总长度。
3. **分片三要素**（参考了PPT中的分片实例）： **数据字段长度**：每个分片中数据部分的大小。 **MF (More Fragment) 标志**：在“标志”字段中。如果MF=1，表示“后面还有分片”；如果MF=0，表示这是“最后一个分片”。 **片偏移 (Fragment Offset)**：数据部分在原始数据报中的位置。必须是**8字节**的倍数。

#### 2. 题目解答

1. **分析原始数据报** IP数据报总长度 = 4000 字节。 IP首部长度 = 20 字节 (固定首部)。 IP数据部分长度 = 4000−20=3980字节。
2. **分析分片限制** 网络MTU (最大IP数据报长度) = 1500 字节。 每个分片都需要一个20字节的IP首部。 每个分片能承载的*最大数据*长度 = MTU - 首部长度 = 1500−20=1480字节。
3. **遵从8字节对齐** 数据长度1480字节是否为8的倍数？ 1480÷8=185。 1480是8的倍数，因此可以使用1480字节作为分片的数据长度。
4. **计算分片数量和详情** 总数据 = 3980 字节。 需要的分片数 = ⌈3980/1480⌉=⌈2.689...⌉=3个分片。 现在计算每个分片的详细信息： **分片 1** **数据字段长度**：1480 字节 (携带原始数据的第 0 - 1479 字节) **MF 标志**：1 (表示后面还有分片) **片偏移字段**：0 (因为 0÷8=0) **分片 2** 剩余数据：3980−1480=2500字节 **数据字段长度**：1480 字节 (携带原始数据的第 1480 - 2959 字节) **MF 标志**：1 (表示后面还有分片) **片偏移字段**：185 (因为 1480÷8=185) **分片 3 (最后一片)** 剩余数据：2500−1480=1020字节 **数据字段长度**：1020 字节 (携带原始数据的第 2960 - 3979 字节) **MF 标志**：0 (表示这是最后一个分片) **片偏移字段**：370 (因为 2960÷8=370)

**总结：**

总共应当划分为 **3** 个数据报片。各分片的数值如下表所示：

| 分片 | 数据字段长度 (字节) | 标志 (MF) | 片偏移字段 (单位: 8字节) |
| ---- | ------------------- | --------- | ------------------------ |
| 1    | 1480                | 1         | 0                        |
| 2    | 1480                | 1         | 185                      |
| 3    | 1020                | 0         | 370                      |





4-22

有如下的4个/24地址块，试进行最大可能的聚合。
212.56.132.0/24
212.56.133.0/24
212.56.134.0/24
212.56.135.0/24

4-27
以下地址中的哪一个和86.32/12匹配？请说明理由。

(1) 86.33.224.123: (2) 86.79.65.216: (3) 86.58.119.74: (4) 86.68.206.154.

4-33
某单位分配到一个地址块 136.23.12.64/26。现在需要进一步划分为4 个一样大的子网。试问：
（1） 每个子网的网络前缀有多长？
（2） 每一个子网中有多少个地址？
（3） 每一个子网的地址块是什么？
（4） 每一个子网可分配给主机使用的最小地址和最大地址是什么？
4-35
试简述 RIP,OSPF 和BGP 路由选择协议的主要特点。
4-37
假定网络中的路由器 B 的路由表有如下的项目（这三列分别表示“目的网络”“距离”和“下一跳路由器”）

N1 7 A

N2 2 C

N6 8 F

N8 4 E

N9 4 F

现在B收到从C发来的路由信息（这两列分别表示“目的网络”和距离）：

N2 4

N3 8

N6 4

N8 3

N9 5

